<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Keto Meal Planner</title>
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700&display=swap" rel="stylesheet">
  <style>
    body { margin:0; padding:0; font-family:'Open Sans',sans-serif; background:#f5f5f5; display:flex; justify-content:center; align-items:flex-start; min-height:100vh; }
    .container { background:#fff; padding:20px; margin:40px; border-radius:8px; max-width:600px; width:100%; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    h1 { text-align:center; }
    .field { margin-bottom:15px; }
    .field label { font-weight:bold; display:block; margin-bottom:5px; }
    .field input, .field select { width:100%; padding:8px; box-sizing:border-box; }
    .field small { color:#666; display:block; margin-top:3px; }
    #foodList, #selectedList { width:100%; height:120px; margin-bottom:10px; }
    button { padding:10px 20px; font-size:16px; margin-right:10px; cursor:pointer; }
    #results { margin-top:20px; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:left; }
    th { background:#eee; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Keto Meal Planner</h1>
    <div class="field">
      <label for="foodSearch">Search Foods:</label>
      <input id="foodSearch" placeholder="Type to filterâ€¦" />
    </div>
    <select id="foodList" multiple></select>
    <select id="selectedList" multiple></select>
    <p><small>Double-click an item to add/remove.</small></p>

    <div class="field">
      <label for="caloriesMin">Calories Min:</label>
      <input type="number" id="caloriesMin" placeholder="e.g. 200" />
      <small>Minimum total calories desired.</small>
    </div>
    <div class="field">
      <label for="caloriesMax">Calories Max:</label>
      <input type="number" id="caloriesMax" placeholder="e.g. 500" />
      <small>Maximum total calories allowed.</small>
    </div>
    <div class="field">
      <label for="ratioMax">Ratio (F:P) Max:</label>
      <input type="text" id="ratioMax" placeholder="e.g. 3:1 or 3.0" />
      <small>Fat-to-protein maximum ratio, colon or decimal.</small>
    </div>
    <div class="field">
      <label for="objectiveType">Objective:</label>
      <select id="objectiveType">
        <option value="0">0: Feasibility Only</option>
        <option value="1">1: Minimize Total Weight</option>
        <option value="2">2: Maximize Protein</option>
        <option value="3">3: Minimize Max Weight</option>
        <option value="4">4: Maximize Min Weight</option>
      </select>
      <small>Choose your optimization objective.</small>
    </div>
    <button id="generateBtn">Generate Meal</button>

    <div id="results"></div>
  </div>

  <script>
    let allFoods = [];
    async function init() {
      allFoods = await fetch('/foods').then(r=>r.json());
      populateList(allFoods, 'foodList');
      document.getElementById('foodSearch').addEventListener('input', e=>{
        const q=e.target.value.toLowerCase();
        populateList(allFoods.filter(f=>f.toLowerCase().includes(q)), 'foodList');
      });
      document.getElementById('foodList').addEventListener('dblclick', e=> moveItem('foodList','selectedList'));
      document.getElementById('selectedList').addEventListener('dblclick', e=> moveItem('selectedList','foodList'));
      document.getElementById('generateBtn').addEventListener('click', submitForm);
    }
    function populateList(arr,id){
      const sel=document.getElementById(id);
      sel.innerHTML=''; arr.forEach(f=>{ let o=new Option(f,f); sel.add(o); });
    }
    function moveItem(from,to){
      const a=document.getElementById(from), b=document.getElementById(to);
      Array.from(a.selectedOptions).forEach(o=>{ b.add(new Option(o.value,o.value)); a.remove(o.index); });
    }
    async function submitForm(){
      // clear results
      document.getElementById('results').innerHTML='';
      const foods=Array.from(document.getElementById('selectedList').options).map(o=>o.value);
      const payload={
        foods, 
        calories_min: parseFloat(document.getElementById('caloriesMin').value)||0,
        calories_max: parseFloat(document.getElementById('caloriesMax').value)||0,
        ratio_max: document.getElementById('ratioMax').value.trim(),
        objective_function_type: parseInt(document.getElementById('objectiveType').value)
      };
      const res=await fetch('/optimize',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const d=res.ok?await res.json():await res.json();
      if(d.error){ document.getElementById('results').innerHTML=`<p style="color:red;">${d.error}</p>`; return; }
      renderResults(d);
    }
    function renderResults(d){
      const r=document.getElementById('results');
      r.innerHTML=`<h3>Meal Plan</h3><pre>${d.meal_plan}</pre><h3>Ingredients</h3><table><tr><th>Name</th><th>g</th><th>Fat</th><th>Prot</th><th>Carb</th><th>Cal</th></tr>${d.ingredients.map(i=>`<tr><td>${i.name}</td><td>${i.grams.toFixed(2)}</td><td>${i.fat.toFixed(2)}</td><td>${i.protein.toFixed(2)}</td><td>${i.carbs.toFixed(2)}</td><td>${i.calories.toFixed(2)}</td></tr>`).join('')}</table><h3>Totals</h3><table><tr><th>Metric</th><th>Amount</th></tr><tr><td>Total Fat</td><td>${d.totals.fat.toFixed(2)}</td></tr><tr><td>Total Prot</td><td>${d.totals.protein.toFixed(2)}</td></tr><tr><td>Total Carb</td><td>${d.totals.carbs.toFixed(2)}</td></tr><tr><td>Total Cal</td><td>${d.totals.calories.toFixed(2)}</td></tr></table>`;
    }
    init();
  </script>
</body>
</html>
